/* Barbs Finder v2.1.0 (Persistent Tracking Edition) - Modified by DermanDanisman - License clause included */
if(typeof DEBUG!=='boolean')DEBUG=false;var scriptConfig={scriptData:{prefix:'barbsFinder',name:'Barbs Finder',version:'v2.1.0',author:'RedAlert',authorUrl:'https://twscripts.dev/',helpLink:'https://forum.tribalwars.net/index.php?threads/barb-finder-with-filtering.285289/'},translations:{en_DK:{'Barbs Finder':'Barbs Finder','Min Points:':'Min Points:','Max Points:':'Max Points:','Radius:':'Radius:','Barbs found:':'Barbs found:','Coordinates:':'Coordinates:','Error while fetching "village.txt"!':'Error while fetching "village.txt"!','Coords':'Coords','Points':'Points','Dist.':'Dist.','Attack':'Attack','Filter':'Filter','Reset':'Reset','No barbarian villages found!':'No barbarian villages found!','Current Village:':'Current Village:','Sequential Scout Script:':'Sequential Scout Script:','Help':'Help','There was an error!':'There was an error!','Include previously scouted':'Include previously scouted','Clear Scouted History':'Clear Scouted History','Scouted history cleared.':'Scouted history cleared.','Invalid village coordinate format (expected xxx|yyy).':'Invalid village coordinate format (expected xxx|yyy).','Please enter valid numeric values.':'Please enter valid numeric values.','Min Points cannot exceed Max Points.':'Min Points cannot exceed Max Points.','Already scouted':'Already scouted','Stored scouted:':'Stored scouted:'}},allowedMarkets:[],allowedScreens:[],allowedModes:[],isDebug:DEBUG,enableCountApi:true};const currentSrc=(document.currentScript&&document.currentScript.src)||location.href;(function(){function k(){if(typeof $==='undefined'){const a=document.createElement('script');a.src='https://code.jquery.com/jquery-3.6.0.min.js';a.onload=l;document.head.appendChild(a)}else l()}function l(){$.getScript('https://twscripts.dev/scripts/twSDK.js?url='+encodeURIComponent(currentSrc),async function(){try{await twSDK.init(scriptConfig)}catch(a){alert('Failed to init twSDK');return}const m=twSDK.scriptInfo(),{villages:n}=await q();if(!n||!Array.isArray(n)){UI.ErrorMessage(twSDK.tt('There was an error!'));console.error(m+' Villages data missing.');return}const r=(window.game_data&&game_data.player&&game_data.player.id.toString())||'0',s=(window.game_data&&game_data.world)||'unknown_world',t=`barbsFinder:scouted:${r}:${s}`;function c(){try{return JSON.parse(localStorage.getItem(t))||{}}catch(a){return{}}}function d(a){localStorage.setItem(t,JSON.stringify(a))}function u(a){if(!Array.isArray(a))return;const b=c(),e=new Date().toISOString();a.forEach(f=>b[f]=e);d(b);v()}function v(){const a=c();$('#scoutedCount').text(Object.keys(a).length)}(function(){const a=`<div class="ra-grid ra-grid-4"><div class="ra-mb15"><label for="raCurrentVillage" class="ra-label">${twSDK.tt('Current Village:')}</label><input type="text" id="raCurrentVillage" value="${game_data.village.coord}" class="ra-input"></div><div class="ra-mb15"><label for="radius_choser" class="ra-label">${twSDK.tt('Radius:')}</label><select id="radius_choser" class="ra-input"><option value="5">5</option><option value="10">10</option><option value="20">20</option><option value="30">30</option><option value="40">40</option><option value="50" selected>50</option><option value="60">60</option><option value="70">70</option><option value="80">80</option><option value="90">90</option><option value="100">100</option><option value="110">110</option><option value="120">120</option><option value="130">130</option><option value="140">140</option><option value="150">150</option><option value="999">999</option></select></div><div class="ra-mb15"><label for="minPoints" class="ra-label">${twSDK.tt('Min Points:')}</label><input type="text" id="minPoints" value="26" class="ra-input"></div><div class="ra-mb15"><label for="maxPoints" class="ra-label">${twSDK.tt('Max Points:')}</label><input type="text" id="maxPoints" value="12154" class="ra-input"></div></div><div class="ra-mb10"><label style="display:inline-flex;gap:6px;align-items:center;cursor:pointer;"><input type="checkbox" id="includePrevScouted"><span>${twSDK.tt('Include previously scouted')}</span></label></div><div class="ra-mb10"><a href="javascript:void(0);" id="btnFilterBarbs" class="btn btn-confirm-yes">${twSDK.tt('Filter')}</a><a href="javascript:void(0);" id="btnResetFilters" class="btn btn-confirm-no">${twSDK.tt('Reset')}</a><a href="javascript:void(0);" id="btnClearScouted" class="btn">${twSDK.tt('Clear Scouted History')}</a></div><div class="ra-mb5"><strong>${twSDK.tt('Barbs found:')}</strong> <span id="barbsCount">0</span> &nbsp; | &nbsp; <strong>${twSDK.tt('Stored scouted:')}</strong> <span id="scoutedCount">0</span></div><div class="ra-grid ra-grid-2 ra-mb15"><div><label for="barbCoordsList" class="ra-label">${twSDK.tt('Coordinates:')}</label><textarea id="barbCoordsList" class="ra-textarea" readonly></textarea></div><div><label for="barbScoutScript" class="ra-label">${twSDK.tt('Sequential Scout Script:')}</label><textarea id="barbScoutScript" class="ra-textarea" readonly></textarea></div></div><div id="barbariansTable" style="display:none;" class="ra-table-container ra-mt15"></div>`,b=`.ra-label{display:block;font-weight:600;margin-bottom:5px}.ra-input{padding:5px;width:100%;display:block;line-height:1;font-size:14px}.ra-grid{display:grid;gap:15px}.ra-grid-2{grid-template-columns:1fr 1fr}.ra-grid-4{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}.btn-already-sent{padding:3px}.already-sent-command{opacity:.6}.badge-scouted{background:#999;color:#fff;padding:2px 5px;border-radius:4px;font-size:10px;margin-left:4px}`;twSDK.renderBoxWidget(a,scriptConfig.scriptData.prefix,'ra-barbs-finder',b)})();(function(){$('#btnFilterBarbs').on('click',function(a){a.preventDefault();const b=$('#raCurrentVillage').val().trim();if(!/^\d{1,3}\|\d{1,3}$/.test(b)){UI.InfoMessage(twSDK.tt('Invalid village coordinate format (expected xxx|yyy).'));return}const e=Number($('#minPoints').val().trim()),f=Number($('#maxPoints').val().trim()),g=Number($('#radius_choser').val());if(Number.isNaN(e)||Number.isNaN(f)||Number.isNaN(g)){UI.InfoMessage(twSDK.tt('Please enter valid numeric values.'));return}if(e>f){UI.InfoMessage(twSDK.tt('Min Points cannot exceed Max Points.'));return}const h=$('#includePrevScouted').is(':checked'),i=c(),j=n.filter(w=>parseInt(w[4],10)===0),o=j.filter(w=>{const x=parseInt(w[5],10);return x>=e&&x<=f}),p=o.map(w=>{const x=`${w[2]}|${w[3]}`,y=twSDK.calculateDistance(b,x);return{raw:w,dist:y,coord:x}}).filter(w=>w.dist<=g);let A=p;h||(A=p.filter(w=>!i[w.coord]));if(!A.length){$('#btnResetFilters').trigger('click');UI.InfoMessage(twSDK.tt('No barbarian villages found!'));return}A.sort((w,x)=>w.dist-x.dist);const B=A.map(w=>w.coord).join(' ');$('#barbsCount').text(A.length);$('#barbCoordsList').text(B);$('#barbScoutScript').val(y(B));const C=A.map(w=>[...w.raw,w.dist]);$('#barbariansTable').show().html(z(C,b,{scoutedMap:i}));$('.btn-send-attack').on('click',function(){const w=$(this).data('coord');w&&(u([w]),$(this).closest('tr').addClass('already-sent-command'),$(this).addClass('btn-confirm-yes btn-already-sent'),$(this).siblings('.badge-scouted').text(twSDK.tt('Already scouted')))})})})();(function(){$('#btnResetFilters').on('click',function(a){a.preventDefault();$('#raCurrentVillage').val(game_data.village.coord);$('#minPoints').val(26);$('#maxPoints').val(12154);$('#radius_choser').val('50');$('#includePrevScouted').prop('checked',false);$('#barbsCount').text('0');$('#barbCoordsList').text('');$('#barbScoutScript').val('');$('#barbariansTable').hide().html('')})})();(function(){$('#btnClearScouted').on('click',function(a){a.preventDefault();if(confirm(twSDK.tt('Clear Scouted History')+'? This cannot be undone.')){localStorage.removeItem(t);v();UI.InfoMessage(twSDK.tt('Scouted history cleared.'))}})})();v();function y(a){const b=t.replace(/'/g,"\\'");return"javascript:(function(){var coords='"+a+"';var doc=document;if(window.frames.length>0&&window.main)doc=window.main.document;var url=doc.URL;if(url.indexOf('screen=place')===-1){alert('Use the script in the rally point page!');return;}var arr=coords.split(' ');var idx=0;var m=document.cookie.match('(^|;) ?farm=([^;]*)(;|$)');if(m)idx=parseInt(m[2],10);if(idx>=arr.length){alert('All villages were extracted, now start from the first!');idx=0;}var c=arr[idx].split('|');idx++;var cd=new Date(2030,1,1);document.cookie='farm='+idx+';expires='+cd.toGMTString();if(doc.forms&&doc.forms[0]){doc.forms[0].x.value=c[0];doc.forms[0].y.value=c[1];var tgt=$('#place_target');if(tgt.length){tgt.find('input').val(c[0]+'|'+c[1]);}doc.forms[0].spy.value=1;}(function(){try{var k='"+b+"';var s=localStorage.getItem(k);var o={};if(s){o=JSON.parse(s);}o[c[0]+'|'+c[1]]=new Date().toISOString();localStorage.setItem(k,JSON.stringify(o));}catch(e){}})();})();"}function z(a,b,e){if(!a.length)return'';const f=(e&&e.scoutedMap)||{},g=a.map((h,i)=>{const j=h[0],o=h[2],p=h[3],A=h[5],B=h[7],C=`${o}|${p}`,D=o.charAt(0)+p.charAt(0),E=!!f[C],F=E?`<span class="badge-scouted">${twSDK.tt('Already scouted')}</span>`:'';return`<tr class="${E?'already-sent-command':''}"><td class="ra-tac">${i+1}</td><td class="ra-tac">K${D}</td><td class="ra-tac"><a href="game.php?screen=info_village&id=${j}" target="_blank" rel="noopener noreferrer">${C}</a> ${F}</td><td>${twSDK.formatAsNumber(A)}</td><td class="ra-tac">${Number(B).toFixed(2)}</td><td class="ra-tac"><a href="/game.php?screen=place&target=${j}&spy=1" target="_blank" rel="noopener noreferrer" class="btn btn-send-attack ${E?'btn-confirm-yes btn-already-sent':''}" data-coord="${C}">${twSDK.tt('Attack')}</a></td></tr>`}).join('');return`<table class="vis overview_table ra-table" width="100%"><thead><tr><th>#</th><th>K</th><th>${twSDK.tt('Coords')}</th><th>${twSDK.tt('Points')}</th><th>${twSDK.tt('Dist.')}</th><th>${twSDK.tt('Attack')}</th></tr></thead><tbody>${g}</tbody></table>`}async function q(){try{const a=await twSDK.worldDataAPI('village');return{villages:a}}catch(a){UI.ErrorMessage(a);console.error(m+' Error:',a);return{villages:[]}}}})}k();})();